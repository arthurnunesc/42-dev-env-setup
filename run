##!/usr/bin/env sh

USER=$(whoami) # Making sure USER variable exists
user_share="/sgoinfre/Perso/$USER"

# Defining install folder
echo "do you want to use /sgoinfre/Perso/$USER/.local/bin as your installation folder? [Y/n] "
read option
if [ "$option" = 'n' ] || [ "$option" = 'N' ]; then
  bin_dir="$HOME/.local/bin"
else
  bin_dir="$user_share/.local/bin"
fi

# Making sure folders exist before installing things into them
if [ -d $user_share ]; then
    echo "$user_share directory already exists."
else
    mkdir $user_share
    chmod -R 700 $user_share
fi
if [ -d $bin_dir ]; then
    echo "$bin_dir directory already exists."
else
    mkdir -p $bin_dir
fi

# Installing brew, always in the $HOME folder
echo "[ brew - begin ]"
if [ -f $HOME/.local/bin/brew ]; then
    echo "brew is already installed."
else
    echo "installing brew..."
    curl -L https://github.com/Homebrew/brew/tarball/master | tar -xz --strip 1 -C $HOME/.local
fi

echo "fetching repos..."
$HOME/.local/bin/brew update -q

echo "upgrading packages..."
$HOME/.local/bin/brew upgrade -q

echo "cleaning up..."
$HOME/.local/bin/brew cleanup -q
echo "[ brew - end ]"

# Installing chezmoi, nvim and kitty
echo "installing chezmoi..."
sh -c "$(curl -fsLS get.chezmoi.io)" -- -b $bin_dir

if [ -f $bin_dir/nvim ]; then
  echo "nvim is already installed."
else
  echo "installing nvim..."
  curl -L https://github.com/neovim/neovim/releases/download/nightly/nvim-macos.tar.gz | tar -xz --strip 1 -C $user_share/.local
fi

if [ -f $bin_dir/kitty.app ]; then
  echo "kitty is already installed."
else
  curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin \
  dest=/sgoinfre/Perso/anunes-c/.local/bin
fi

# Dotfiles
$bin_dir/chezmoi init --apply https://github.com/arthurnunesc/dotfiles.git
