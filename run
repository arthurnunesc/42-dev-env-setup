#!/usr/bin/env sh

USER=$(whoami) # Making sure USER variable exists
user_share="/sgoinfre/Perso/$USER"

# Defining install folder
echo "do you want to use /sgoinfre/Perso/$USER/.local/bin as your installation folder? [Y/n] "
read option
if [ "$option" = 'n' ] || [ "$option" = 'N' ]; then
  bin_dir="$HOME/.local/bin"
else
  bin_dir="$user_share/.local/bin"
fi

# Making sure folders exist before installing things into them
if [ -d "$user_share" ]; then
    echo "$user_share directory already exists."
else
    mkdir "$user_share"
    chmod -R 700 "$user_share"
fi
if [ -d "$bin_dir" ]; then
    echo "$bin_dir directory already exists."
else
    mkdir -p "$bin_dir"
fi

# Installing brew, always in the $HOME/.brew folder
echo "[ brew - begin ]"
if [ -f "$HOME"/.brew/bin/brew ]; then
  echo "brew is already installed."
else
  echo "installing brew..."
  rm -rf "$HOME"/.brew && git clone --depth=1 https://github.com/Homebrew/brew $HOME/.brew
fi
echo "fetching repos..."
"$HOME"/.brew/bin/brew update -q
echo "upgrading packages..."
"$HOME"/.brew/bin/brew upgrade -q
echo "cleaning up..."
"$HOME"/.brew/bin/brew cleanup -q
echo "[ brew - end ]"


# Installing chezmoi, nvim, kitty and starship
if [ -f "$bin_dir"/chezmoi ]; then
  echo "chezmoi is already installed."
else
  echo "installing chezmoi..."
  sh -c "$(curl -fsLS get.chezmoi.io)" -- -b "$bin_dir"
fi

if [ -f "$bin_dir"/nvim ]; then
  echo "nvim is already installed."
else
  echo "installing nvim..."
  if [ "$option" = 'n' ] || [ "$option" = 'N' ]; then
    curl -L https://github.com/neovim/neovim/releases/download/stable/nvim-macos.tar.gz | tar -xz --strip 1 -C "$HOME"/.local
  else
    curl -L https://github.com/neovim/neovim/releases/download/stable/nvim-macos.tar.gz | tar -xz --strip 1 -C "$user_share"/.local
  fi
fi

if [ -f "$bin_dir"/kitty ]; then
  echo "kitty is already installed."
else
  echo "installing kitty..."
  curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin \
  dest=/sgoinfre/Perso/anunes-c/.local/bin
fi

if [ -f "$bin_dir"/starship ]; then
  echo "starship is already installed."
else
  echo "installing starship..."
  curl -L https://github.com/starship/starship/releases/latest/download/starship-x86_64-apple-darwin.tar.gz | tar -xz -C "$bin_dir"
fi

if [ -f "$bin_dir"/Obsidian ]; then
  echo "obsidian is already installed."
else
  echo "installing obsidian..."
  curl -L https://github.com/obsidianmd/obsidian-releases/releases/download/v1.1.16/Obsidian-1.1.16-universal.dmg | tar -xz -C "$bin_dir"
fi

# Installing command line utilities
brew install fzf

# Dotfiles
"$bin_dir"/chezmoi init --apply git@github.com:arthurnunesc/dotfiles.git
